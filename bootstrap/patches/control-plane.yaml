apiVersion: v1alpha1
kind: MachinePatch
metadata:
  name: control-plane-patch
  namespace: default
spec:
  description: "Configuration patch for Talos control plane nodes"
  
  # Machine configuration patches
  machine:
    type: controlplane
    kubelet:
      nodeIP:
        validSubnets:
          - 0.0.0.0/0
      extraArgs:
        rotate-server-certificates: "true"
    
    # System disk configuration
    install:
      disk: /dev/sda
      image: ghcr.io/siderolabs/installer:v1.7.0
      wipe: false
    
    # Network configuration
    network:
      hostname: ""
      interfaces:
        - interface: eth0
          dhcp: true
    
    # Time sync
    time:
      servers:
        - time.cloudflare.com
    
    # Features
    features:
      rbac: true
      stableHostname: true
  
  # Cluster configuration patches
  cluster:
    controlPlane:
      endpoint: https://cluster-endpoint:6443
    
    # API Server configuration
    apiServer:
      extraArgs:
        anonymous-auth: "false"
        audit-log-maxage: "30"
        audit-log-maxbackup: "10"
        audit-log-maxsize: "100"
    
    # Controller Manager configuration
    controllerManager:
      extraArgs:
        bind-address: "0.0.0.0"
    
    # Scheduler configuration
    scheduler:
      extraArgs:
        bind-address: "0.0.0.0"
    
    # Etcd configuration
    etcd:
      extraArgs:
        listen-metrics-urls: http://0.0.0.0:2381
