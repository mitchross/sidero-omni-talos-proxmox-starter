# patches/cilium-cni.yaml
#
# UPDATED for Cilium 1.18.x and Gateway API 1.5.x
# Bootstraps Cilium with all your production settings.

name: cilium-install-gateway
inline:
  cluster:
    proxy:
      disabled: true
    network:
      cni:
        name: none

  manifests:
    # 1. Gateway API CRDs (Must be installed BEFORE Cilium)
    - name: gateway-api-crds
      # UPDATED to v1.5.0 (as requested)
      url: https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.5.0/standard-install.yaml

    # 2. Cilium HelmChart with ALL your values merged
    - name: cilium
      inline:
        apiVersion: helm.cattle.io/v1
        kind: HelmChart
        metadata:
          name: cilium
          namespace: kube-system
        spec:
          chart: https://helm.cilium.io/
          # UPDATED to 1.18.4 (latest stable 1.18.x)
          version: 1.18.4
          targetNamespace: kube-system
          valuesContent: |
            # --- Talos Essentials (from patch) ---
            ipam:
              mode: kubernetes
            kubeProxyReplacement: true
            k8sServiceHost: localhost
            k8sServicePort: 7445
            securityContext:
              capabilities:
                ciliumAgent:
                  - CHOWN
                  - KILL
                  - NET_ADMIN
                  - NET_RAW
                  - IPC_LOCK
                  - SYS_ADMIN
                  - SYS_RESOURCE
                  - DAC_OVERRIDE
                  - FOWNER
                  - SETGID
                  - SETUID
                cleanCiliumState:
                  - NET_ADMIN
                  - SYS_ADMIN
                  - SYS_RESOURCE
            cgroup:
              autoMount:
                enabled: false
              hostRoot: /sys/fs/cgroup

            # --- Your Production Settings (All still valid) ---
            routingMode: native
            autoDirectNodeRoutes: true
            ipv4NativeRoutingCIDR: 10.14.0.0/16 # Make sure this is still your Pod CIDR

            socketLB:
              enabled: true
              hostNamespaceOnly: false

            bandwidthManager:
              enabled: true
              bbr: true

            bpf:
              masquerade: true
              ctTcpTimeout: 21600
              ctAnyTimeout: 3600

            l2announcements:
              enabled: true
              leaseDuration: "15s"
              leaseRenewDeadline: "5s"
              leaseRetryPeriod: "2s"

            loadBalancer:
              acceleration: best-effort

            k8sClientRateLimit:
              qps: 20
              burst: 40

            gatewayAPI:
              enabled: true
              enableAlpn: true         # Still valid
              enableAppProtocol: true  # Still valid
              # Your critical fixes
              externalTrafficPolicy: Local
              sessionAffinity: true
              sessionAffinityTimeoutSeconds: 10800

            hubble:
              enabled: true
              relay:
                enabled: true
              ui:
                enabled: true

            operator:
              replicas: 2
              affinity:
                podAntiAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                  - labelSelector:
                      matchLabels:
                        io.cilium/app: operator
                    topologyKey: kubernetes.io/hostname